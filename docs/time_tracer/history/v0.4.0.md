## 0.4.0.0 - 2026-01-11


### 优化core结构

### 提取converter和importer共同数据结构

**目标**：消除 `converter`（生产者）和 `importer`（消费者）之间的数据定义冗余，建立统一的数据契约，降低维护成本。

#### **1. 新增公共模型 (`common`)**

* **文件**：创建了 `common/model/TimeDataModels.hpp`。
* **内容**：
* `struct ActivityStats`：统一了所有统计字段（如 `sleep_night_time`, `recreation_bilibili_time`），采用 **snake_case** 命名，与数据库列名直接对应。
* `struct BaseActivityRecord`：统一了基础活动记录字段（如 `logical_id`, `start_time_str`, `project_path`）。



#### **2. Converter 模块重构**

* **模型变更**：`InputData` 现在直接包含 `ActivityStats stats` 和 `std::vector<BaseActivityRecord> processedActivities`，删除了原有的 `GeneratedStats` 和 `Activity` 结构体。
* **逻辑适配**：
* 更新了 `DayStats` 和 `StatsRules`，适配新的 snake_case 字段名。
* 更新了 `ActivityMapper` 和 `DayProcessor`，使用 `BaseActivityRecord` 构建数据。
* 更新了 `Output` (JSON 生成)，字段键名与新模型保持一致。



#### **3. Importer 模块重构**

* **模型变更**：
* `DayData` 移除了十几个散落的 int 字段，改为包含一个 `ActivityStats stats` 成员。
* `TimeRecordInternal` 现在继承自 `BaseActivityRecord`，复用了大部分字段定义。


* **逻辑适配**：
* **内存解析 (`MemoryParser`)**：极大地简化了代码，利用结构体赋值（`day_data.stats = input_day.stats`）直接传递数据，不再需要逐字段拷贝。
* **JSON 解析 (`DayParser`, `ActivityParser`)**：适配了新的 JSON 结构和字段名。
* **数据库写入 (`Writer`)**：更新了 `sqlite3_bind` 逻辑，从嵌套的 `stats` 结构和基类中读取数据。



#### **本次更新的收益**

1. **单一数据源 (Single Source of Truth)**：新增统计字段（如阅读时间）只需在 `common` 中定义一次。
2. **代码简化**：`MemoryParser` 中的映射逻辑大幅减少。
3. **类型安全与规范**：统一使用 C++ 标准推荐的 snake_case 命名数据成员，消除了驼峰命名与数据库字段名之间的转换心智负担。



这是一份整理后的更新日志（Markdown 格式），我优化了结构层级，补齐了模块分类，并统一了排版风格，使其更具专业文档的观感。

---

## v0.4.0.1 (2026-01-11)

### 0. 更新概览

本次版本是一次针对核心架构的**大规模重构**。更新主要围绕 **“性能优化”**、**“内存管理”** 和 **“架构解耦”** 三个维度展开，覆盖了数据从解析、入库到查询的全生命周期。

### 核心收益
*   **内存占用**：从全量加载优化为流式处理，内存占用大幅降低且恒定。
*   **入库速度**：通过消除 N+1 查询，入库效率提升数个数量级。
*   **查询响应**：从线性增长转变为近乎常量时间的瞬时响应。

---

## 1. Converter 模块 (数据转化)

### 变更背景
旧版本采用“全量加载”模式，在处理超大日志文件时会导致内存溢出（OOM）。

### 主要优化
*   **架构变更**：引入 **流式流水线 (Streaming Pipeline)** 模式。
*   **核心算法**：
    *   使用**滑动窗口算法**处理跨天逻辑，确保逻辑正确性的同时最小化内存占用。
    *   利用 `std::move` 语义实现**零拷贝 (Zero-copy)** 数据传递。
*   **性能收益**：
    *   内存占用显著降低（仅需常驻缓存两天的数据量）。
    *   理论上支持处理无限大的日志文件。

### 代码映射
*   `ConverterPipeline.cpp`: 负责流式逻辑控制。
*   `SlidingWindow.hpp`: 实现跨天数据处理。

---

## 2. Importer 模块 (数据持久化)

### 变更背景
旧版本在插入 `TimeRecord` 时，会对每条记录进行路径切割并递归查询数据库以获取 Project ID，产生了严重的 **N+1 查询问题**，导致批量导入极其缓慢。

### 主要优化
*   **批量解析器 (ProjectResolver)**:
    *   新增 `ProjectResolver` 类，在内存中构建并维护 `ImportProjectNode` 树。
    *   **预加载机制**: 启动时一次性加载 `projects` 表，减少数据库交互。
    *   **极速查找**: 利用 `unordered_map` 实现 $O(1)$ 级别的 `Path -> ID` 映射查找。
*   **事务优化**:
    *   将所有写入操作严格封装在 SQLite 事务 (`BEGIN/COMMIT`) 中，提升 IO 效率。
*   **逻辑解耦**:
    *   重构 `Writer` 类，使其不再参与树构建逻辑，仅负责 Resolver 调度与 SQL 执行。

### 代码映射
*   `ProjectResolver.cpp`: 封装 ID 解析与缓存逻辑。
*   `Writer.cpp`: 负责协调批量写入与事务管理。

---

## 3. Reports 模块 (查询与可视化)

### 变更背景
旧版本查询依赖递归 SQL (`WITH RECURSIVE`) 拉取流水记录，并在 C++ 层进行复杂的字符串切割来重建项目树，造成了严重的数据库 I/O 压力和 CPU 算力浪费。

### 主要优化
*   **数据库级聚合 (DB Aggregation)**:
    *   SQL 优化：由全量拉取改为 `GROUP BY project_id` 的聚合查询，极大地压缩了传输数据量。
*   **ID 缓存机制 (ID Caching)**:
    *   引入 `ProjectNameCache` 单例，缓存 `ID -> Path` 映射。
    *   **零切割逻辑**: 彻底移除 C++ 层的 `split_string` 操作，直接通过 ID 在内存中还原路径层级。
*   **数据驱动配置 (Data-Driven Config)**:
    *   重构 `StatFormatter`，支持**递归解析 JSON 配置** (`sub_items`)。
    *   **动态扩展**: 新增统计指标（如 `recreation_douyin_time`）仅需修改配置文件，无需重新编译。

### 代码映射
*   `BaseQuerier.hpp`: 定义核心聚合 SQL 逻辑。
*   `ProjectNameCache.hpp`: 高效 ID 到路径的映射实现。
*   `ReportDataUtils.cpp`: 提供 `build_project_tree_from_ids` 核心接口。
*   `Day/Month/PeriodQuerier.cpp`: 适配新的 ID 聚合构建逻辑。

---

## 4. 总结

| 指标 | 优化前 | 优化后 |
| :--- | :--- | :--- |
| **内存管理** | 随文件大小线性增长 | 常量级内存占用 (2天数据窗口) |
| **入库效率** | 路径切割 + N次递归查询 | 1次全量加载 + $O(1)$ 哈希查找 |
| **查询性能** | 递归查询 + 字符串切割 (慢) | 数据库聚合 + 内存映射 (快) |
| **可扩展性** | 指标硬编码，需改动代码 | JSON 驱动，动态配置统计项 |

## v0.4.0.2 (2026-01-11)

### cli和io彻底解耦
ConfigLoader.cpp移动到config

config_validator移动到config

## v0.4.0.3 (2026-01-11)

### 优化converter文件名和文件结构
DailyLog.hpp(原名InputData)移动到common/model，因为这个hpp被converter和importer共用

优化文件名和文件结构


## v0.4.0.4 (2026-01-13)

### json配置重命名
reprocessing重命名为converter

修改对应代码

### 优化reports/shared目录
daily monthly period的一部分没有使用reports/shared中的代码
现在修改让他们使用

### 优化reports/daily


## v0.4.0.5 (2026-01-13)

### 优化reports/service性能
优化日报告/月报告/周期报告导出性能

### 复用fomatter重复代码

### 重命名文件名
