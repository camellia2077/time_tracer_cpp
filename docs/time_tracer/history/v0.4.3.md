## v0.4.3.0 - 2026-01-20

### Features (新特性)

* **跨月数据自动衔接 (Automatic Cross-Month Continuity)**
* 引入了全新的 **`LogLinker`** 核心组件，实现了跨文件（月度）的数据上下文自动关联。
* 系统现在能够智能识别上个月最后一天的结束时间，并自动为本月第一天补全缺失的睡眠记录，无需用户手动复制跨月数据。


* **动态起床判定策略 (Dynamic Wake Detection)**
* 重构了睡眠/通宵判定逻辑，完全基于用户配置的 `wake_keywords` 动态决定。
* 严格区分“通宵”与“跨月睡眠”场景：只有当检测到明确的起床关键词但缺少睡眠记录时，才会触发自动补全逻辑。



### Improvements (改进)

* **严格源文件校验 (Stricter Source Validation)**
* 升级了 `TextValidator` 和 `StructureRules`，增加了对文件结构的严格约束。
* **单文件单年份规则**：限制每个源文件仅能包含一个年份头，确保数据结构清晰。
* **首日对齐规则**：强制要求月度记录文件必须从当月 1 号开始记录，提升了时间线的规范性。


* **流水线编排优化 (Pipeline Orchestration)**
* 在 `PipelineManager` 中集成了 **`LogicLinkerStep`**，将逻辑链接步骤标准化地嵌入到“并行转换”与“输出验证”之间，确保了数据处理流的完整性。


### Technical (技术细节)

* **模块化业务封装 (Modular Logic Encapsulation)**
* 遵循 **"Core Orchestrates, Converter Implements"** 的架构原则，将跨月时间计算与逻辑衔接功能直接封装于 `Converter` 模块内部（`LogLinker`）。`Core` 层仅负责流水线调度，不感知具体的日记业务规则，确保了各模块职责单一且清晰。


* **混合并发模型 (Hybrid Concurrency Model)**
* 设计了 **“并行解析 + 串行链接”** 的处理流。文件转换阶段（`ConverterStep`）保持全并行处理以最大化 I/O 吞吐量，而依赖上下文的跨月衔接逻辑作为独立的后处理步骤串行执行。这种设计在确保数据上下文完整性（Stateful）的同时，维持了文件处理的高性能（Stateless）。

### Fixes & Improvements (修复与改进)

本次更新主要修复了导出模块的接口调用错误，并进一步贯彻“瘦 CLI”原则，将批量查询的循环逻辑下沉至核心层。

#### 1. CLI 逻辑下沉 (Logic Push-down)

* **批量查询逻辑移至 Core**：
* 之前 `query period 7,30` 的循环逻辑是在 CLI (`QueryCommand`) 中实现的，这与 `ExportCommand` 的处理方式不一致。
* 现在，我们在核心接口 `IReportHandler` 中新增了 **`run_period_queries`** 方法，将参数解析后的列表直接传递给 Core 处理。
* **变更文件**：`cli/impl/commands/query/query_command.cpp` → `core/reporting/report_handler.cpp`



#### 2. 导出模块编译修复 (Export Compilation Fixes)

* **修正方法签名不匹配**：
* 修复了 `ReportHandler` 调用 `Exporter` 时的方法名混淆问题（例如误将单次导出 `export_single_day_report` 调用为批量导出接口）。
* 修正了批量导出（`export_all_*`）时的参数类型错误，确保正确传递 `FormattedReports` 集合结构而非原始字符串内容。
* **变更文件**：`core/reporting/report_handler.cpp`


## v0.4.3.1 - 2026-01-22
### 核心重构 (Refactoring & Core)

* **JSON 库全面迁移**: 将项目中所有的 JSON 处理逻辑从 C++ 模板库 `nlohmann/json` 迁移至高性能 C 语言库 **`yyjson`**。
* **Serializer**: 重写 `LogSerializer` 和 `LogDeserializer`，实现了基于 `yyjson` 的序列化与反序列化，显著降低了编译依赖。
* **Validator**: 更新 `JsonValidator` 及规则模块（如 `DateRules`），适配 `yyjson` 的 C-API 进行数据校验。
* **Config**: 重构 `shared/config_utils`，使 Reports 动态库在加载配置时不再依赖庞大的 C++ JSON 库。


* **Importer 解耦**: 彻底移除 `Importer` 模块对 JSON 的直接依赖。现在数据流由 `Serializer` 解析为结构体后，直接通过内存对象传递给 `Importer`，实现了各层职责的纯净分离。
* **PIMPL 模式修复**: 修复了 `ReportHandler` 中因使用 `std::unique_ptr` 指向不完整类型（Forward Declaration）而导致的编译错误，显式添加了析构函数定义。

### 构建系统 (Build System)

* **依赖管理**:
* 通过 `add_subdirectory` 集成 `yyjson` 源码，并强制将其编译为 **动态链接库 (DLL)**，避免静态链接导致的可执行文件体积膨胀。
* 配置了自动安装规则，确保 `yyjson.dll` 会被正确复制到 `bin/` 目录。


* **编译器兼容性**:
* 在 `scripts/config.toml` 中默认 **关闭 LTO (Link-Time Optimization)**，以修复 GCC 15.2.0 在处理复杂 C++23 符号时发生的内部编译器错误 (ICE)。
* 启用了 `CMAKE_CLI_FORCE_UTF8`，解决了 Windows 环境下 CMake 输出中文乱码的问题。


* **子项目修复**: 修正了辅助工具 `log_generator` 的构建配置，补充了缺失的 `yyjson` 链接依赖。

### 性能优化 (Performance)

* **解析速度**: 受益于 `yyjson` 的引入，JSON 数据的读写性能得到理论上的大幅提升。
* **编译速度**: 移除了重型模板库 `nlohmann/json` 头文件引用，减少了预编译头文件 (PCH) 的大小和编译单元的解析时间。





## v0.4.3.2 - 2026-01-23

### 架构重构 (Architecture & Refactoring)

* **IO 依赖抽象化 (IO Dependency Abstraction)**:
* **核心解耦 (Core Decoupling)**: 将 `Core` 层业务逻辑与物理文件系统 (`std::filesystem`, `std::fstream`) 彻底解耦，遵循依赖倒置原则 (DIP)。
* **接口定义**: 新增 `core::interfaces::IFileSystem` 接口，统一定义了文件读取、写入、查找及状态检查等操作契约。
* **统一实现**: 在 `IO` 层新增 `io::impl::DiskFileSystem` 类，整合了原有的分散逻辑，提供基于磁盘操作的统一实现。


* **全链路依赖注入 (Full-Stack Dependency Injection)**:
* **Pipeline & Workflow**: `PipelineManager`、`WorkflowHandler` 及 `PipelineContext` 现通过构造函数接收 `IFileSystem` 实例，消除了核心流程中的隐式 IO 依赖。
* **Config & Validation**: 配置加载工厂 (`ConverterConfigFactory`、`ReportConfigLoader`) 和验证器 (`StartupValidator`、`PluginValidator`) 均已改造为支持接口注入，使得配置读取和环境检查逻辑也具备了可测试性。
* **Exporter**: 导出模块现在通过注入的 `IFileSystem` 进行文件生成，便于隔离测试导出逻辑。


* **CLI 框架升级 (CLI Framework Updates)**:
* **服务容器增强**: `AppContext` 新增 `file_system` 共享指针成员，作为应用级的文件系统服务提供者。
* **Command 适配**: `ValidateStructureCommand`、`ValidateLogicCommand` 等命令现在从 `AppContext` 获取文件系统实例并传递给 Core 层，不再在命令内部实例化底层依赖。


* **代码清理与规范 (Code Cleanup & Standardization)**:
* **移除静态耦合**: 重构了 `FileCollector`, `ConverterStep`, `StructureValidatorStep` 及 `ProcessedDataWriter`，将原有的静态方法调用替换为接口调用。
* **废弃遗留组件**: 彻底删除了 `FileController` 类以及 `io/core/` (`FileReader`, `FileWriter`, `FileSystemHelper`) 和 `io/utils/` 下的所有静态工具类，消除了“上帝对象”和静态方法滥用。
* **Composition Root**: `CliApplication` 现在作为组合根，负责实例化具体的 `DiskFileSystem` 并将其注入到各个服务组件中。



### 测试性提升 (Testability)

* **Mock 支持**: 由于引入了 `IFileSystem` 接口，现在可以轻松创建内存虚拟文件系统 (MockFileSystem) 来对 `Core` 层逻辑（包括配置加载、转换、验证、导出）进行纯内存单元测试，而无需产生实际的磁盘 I/O 或临时文件。



## v0.4.3.3 - 2026-01-23

### 核心架构重构 (Core Architecture Refactoring)

* **UI 与核心逻辑解耦 (Decoupling UI from Core)**:
* 移除了 `Core` 层（包括 Pipeline Steps, WorkflowHandler, Exporter 等）中所有的 `iostream` (`std::cout`, `std::cerr`) 依赖。
* 移除了 `Core` 层对 `common/ansi_colors.hpp` 的直接依赖，业务逻辑不再感知控制台颜色。
* 引入了 `core::interfaces::IUserNotifier` 接口，用于抽象信息、成功、警告和错误消息的通知机制。


* **管道模式重构 (Pipeline Pattern Implementation)**: [新增]
* **废弃上帝类**: 移除了臃肿的 `PipelineManager` 类，将其职责拆分为 `PipelineRunner` (负责按序执行步骤) 和 `PipelineFactory` (负责根据 Options 组装步骤)。
* **标准化接口**: 所有处理步骤 (`FileCollector`, `ConverterStep` 等) 现在均严格继承自 `IPipelineStep` 接口，便于扩展和测试。
* **步骤封装**:
* 新增 `ConfigLoaderStep`: 专门负责在流水线前置阶段加载 `mapping_config.toml` 等业务配置，解决了重构后配置未加载导致中文映射失效的问题。
* 新增 `ProcessedDataWriterStep`: 将原来硬编码在 Manager 中的文件写入逻辑封装为独立的标准步骤。




* **服务层提取 (Service Layer Extraction)**: [新增]
* **ImportService 独立**: 从 `WorkflowHandler` 中剥离出 `core::service::ImportService`。
* **职责分离**: `WorkflowHandler` 现在退化为纯粹的流程协调者 (Coordinator)，不再包含文件读取、JSON 解析或具体的数据库导入逻辑。


* **基础设施倒置与存储库模式 (Infrastructure Inversion & Repository Pattern)**:
* **新增接口**: 在领域层定义了 `core::domain::repositories::IReportRepository` 接口，抽象了报表数据的获取逻辑。
* **解除依赖**: `ReportGenerator` 不再直接持有 `sqlite3*` 指针或依赖具体的 `ReportService` 类，改为依赖抽象的 `IReportRepository` 接口。实现了业务逻辑与底层数据库实现的解耦。
* **下沉实现**: 新增基础设施层实现 `infrastructure::persistence::SqliteReportRepository`，将原有的 `ReportService` 和 SQL 操作封装在基础设施层内部。


* **Validator 模块纯净化 (Validator Purification)**:
* `Validator` 模块（JsonValidator, TextValidator）不再直接向控制台打印错误。
* 新增 `validator::format_error_report` 工具函数，验证器现在返回格式化的错误字符串或结构化数据，由上层决定如何展示。



### 基础设施层重构 (Infrastructure Layer Refactoring)

* **DBManager 纯净化**:
* 移除了 `DBManager` 中所有的控制台打印代码（`std::cerr`, `RED_COLOR` 等）。
* 修改为使用 C++ 异常机制（`std::runtime_error`）来报告数据库打开/连接失败等错误，交由上层应用捕获处理。



### CLI 层更新 (CLI Layer Updates)

* **命令重构**: [新增]
* `ValidateStructureCommand`, `ValidateLogicCommand`, `IngestCommand`: 更新为使用 `PipelineFactory` 创建流水线，不再依赖旧的 `PipelineManager`。


* **控制台通知器实现**:
* 新增 `cli/impl/ui/console_notifier.hpp/cpp`，实现了 `IUserNotifier` 接口，负责具体的控制台输出和 ANSI 颜色渲染。


* **依赖注入与组合根 (Dependency Injection)**:
* 更新 `CliApplication` 作为组合根（Composition Root），负责组装 `DBManager`、`SqliteReportRepository`、`ConsoleNotifier` 和 `DiskFileSystem`。
* 将 `IUserNotifier` 注入到 `WorkflowHandler`、`PipelineRunner` (via Context) 和 `Exporter` 中。
* 将 `IReportRepository` 注入到 `ReportGenerator` 中。



### 修复 (Bug Fixes)

* **编译与链接修复**: [新增]
* 修复了 CMake 构建列表，补充了遗漏的源文件 (`pipeline_factory.cpp`, `pipeline_runner.cpp`, `import_service.cpp`, `config_loader_step.cpp`)，解决了 Linker Error。


* **配置加载修复**: [新增]
* 修复了 Pipeline 重构后 `StructureValidator` 和 `Converter` 因缺少配置加载步骤而无法识别中文活动名的问题。


* **其他修复**:
* 修复了 `core/pipeline/steps/converter_step.hpp` 头文件声明与 cpp 实现不一致的问题。
* 修复了 `ReportHandler` 在导出单日/单月/周期报表时，错误调用了批量导出接口的问题。
* 修复了 `ReportHandler` 在批量导出时未正确传递数据集合的问题。



