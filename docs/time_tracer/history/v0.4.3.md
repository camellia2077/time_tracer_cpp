## v0.4.3.0 - 2026-01-20

### Features (新特性)

* **跨月数据自动衔接 (Automatic Cross-Month Continuity)**
* 引入了全新的 **`LogLinker`** 核心组件，实现了跨文件（月度）的数据上下文自动关联。
* 系统现在能够智能识别上个月最后一天的结束时间，并自动为本月第一天补全缺失的睡眠记录，无需用户手动复制跨月数据。


* **动态起床判定策略 (Dynamic Wake Detection)**
* 重构了睡眠/通宵判定逻辑，完全基于用户配置的 `wake_keywords` 动态决定。
* 严格区分“通宵”与“跨月睡眠”场景：只有当检测到明确的起床关键词但缺少睡眠记录时，才会触发自动补全逻辑。



### Improvements (改进)

* **严格源文件校验 (Stricter Source Validation)**
* 升级了 `TextValidator` 和 `StructureRules`，增加了对文件结构的严格约束。
* **单文件单年份规则**：限制每个源文件仅能包含一个年份头，确保数据结构清晰。
* **首日对齐规则**：强制要求月度记录文件必须从当月 1 号开始记录，提升了时间线的规范性。


* **流水线编排优化 (Pipeline Orchestration)**
* 在 `PipelineManager` 中集成了 **`LogicLinkerStep`**，将逻辑链接步骤标准化地嵌入到“并行转换”与“输出验证”之间，确保了数据处理流的完整性。


### Technical (技术细节)

* **模块化业务封装 (Modular Logic Encapsulation)**
* 遵循 **"Core Orchestrates, Converter Implements"** 的架构原则，将跨月时间计算与逻辑衔接功能直接封装于 `Converter` 模块内部（`LogLinker`）。`Core` 层仅负责流水线调度，不感知具体的日记业务规则，确保了各模块职责单一且清晰。


* **混合并发模型 (Hybrid Concurrency Model)**
* 设计了 **“并行解析 + 串行链接”** 的处理流。文件转换阶段（`ConverterStep`）保持全并行处理以最大化 I/O 吞吐量，而依赖上下文的跨月衔接逻辑作为独立的后处理步骤串行执行。这种设计在确保数据上下文完整性（Stateful）的同时，维持了文件处理的高性能（Stateless）。

### Fixes & Improvements (修复与改进)

本次更新主要修复了导出模块的接口调用错误，并进一步贯彻“瘦 CLI”原则，将批量查询的循环逻辑下沉至核心层。

#### 1. CLI 逻辑下沉 (Logic Push-down)

* **批量查询逻辑移至 Core**：
* 之前 `query period 7,30` 的循环逻辑是在 CLI (`QueryCommand`) 中实现的，这与 `ExportCommand` 的处理方式不一致。
* 现在，我们在核心接口 `IReportHandler` 中新增了 **`run_period_queries`** 方法，将参数解析后的列表直接传递给 Core 处理。
* **变更文件**：`cli/impl/commands/query/query_command.cpp` → `core/reporting/report_handler.cpp`



#### 2. 导出模块编译修复 (Export Compilation Fixes)

* **修正方法签名不匹配**：
* 修复了 `ReportHandler` 调用 `Exporter` 时的方法名混淆问题（例如误将单次导出 `export_single_day_report` 调用为批量导出接口）。
* 修正了批量导出（`export_all_*`）时的参数类型错误，确保正确传递 `FormattedReports` 集合结构而非原始字符串内容。
* **变更文件**：`core/reporting/report_handler.cpp`



