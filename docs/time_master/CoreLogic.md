# 预处理子系统核心业务逻辑 (Reprocessing Core Logic)

本模块负责将非结构化的原始文本转换为逻辑严密、富含语义的结构化数据，其核心处理流程分为以下四个阶段：

## 1. 输入解析机制：时间轴的“变化点”记录

系统采用**增量记录法**构建时间流，核心在于识别用户记录的每一个“切换点”。

* **逻辑模型**：用户仅需记录活动**结束**的时间。系统自动将上一条记录的结束时间作为当前活动的开始时间。
* **词法分析 (Input Parsing)**：`InputParser` 组件按行解析文本：
* **时间提取**：识别行首前 4 位数字（HHMM）作为活动的结束时间 (`endTimeStr`)。
* **语义分离**：将时间数字后的第一个连续字符串识别为“描述”，将注释符（`//`, `#`, `;`）后的内容提取为“备注”。


* **上下文状态机**：解析器维护“年份锚点”（如 `y2025`）和“日期锚点”（如 `0101`）状态。所有活动行会自动继承当前的日期上下文，生成完整的 YYYYMMDD 日期属性。

## 2. 三级语义映射漏斗 (Semantic Mapping)

在 `ActivityMapper` 模块中，原始描述字符串通过三层过滤转化为标准化的 `project_path`：

* **层级一：别名标准化 (Alias Normalization)**：通过 `TextMapping` 配置，将多变的词汇（如 `gym`, `举铁`）统一映射为标准词汇。
* **层级二：动态时长修正 (Duration-based Reclassification)**：
* **逻辑**：根据计算出的活动时长，参照 `DurationRules` 进行二次判定。
* **示例**：若活动为 `reading` 但时长 < 15 分钟，系统自动重映射为 `browsing`。


* **层级三：路径构建与顶层映射**：
* **层级化**：支持通过下划线（`_`）构建树状路径（如 `study_cpp_coding`）。
* **全限定对齐**：通过 `topParentMapping` 确保路径起始节点符合系统顶级分类（如 `study`, `exercise`），以便进行分类汇总统计。


### 修改后的版本推荐

## 3. 跨天与跨月睡眠推导机制

系统具备自动推导功能，能够根据前一日的结束与次日的开始自动生成 `sleep_night`（深夜睡眠）活动。用户无需手动记录入睡时间，只需记录起床或当日的首个活动。

* **触发与推导逻辑**：
* **起床定位**：识别当日数据中的“起床”类关键词以锁定起床时刻。
* **时间链接**：系统会自动检索逻辑上的“前一日”数据及其最后一条活动的结束时刻。
* **合法性判定**：若当日非连续状态，且前一日结束时间早于当日起床时间，系统将自动缝合这段时间差。


* **跨周期处理（占位机制）**：
* **数据引导**：支持在处理当前周期（如新月份）时，引入前一周期最后一天的数据作为推导参考。
* **自动净化**：若引导数据仅用于生成跨年/跨月睡眠（如 12 月 31 日引导 1 月 1 日），系统在完成逻辑计算后会自动从最终输出中移除该引导日，确保统计数据的纯净。



#### 3.1 场景示例说明

**示例 A：跨年场景（2024-12-31 至 2025-01-01）**

* **输入示例**：
```text
y2024
1231
2335 洗漱  // 关键：提供去年的收尾时间

y2025
0101
0743 起床  // 新年的开始

```


* **处理逻辑**：
1. **年份锚定**：系统识别日期所属的特定年份标签。
2. **数据缝合**：提取 12 月 31 日 23:35 至 1 月 1 日 07:43 之间的时段。
3. **活动合成**：在 1 月 1 日的活动列表首位自动插入一条“深夜睡眠”记录。
4. **冗余剔除**：由于 12 月 31 日仅作为参考，系统在最终报告中将仅保留 1 月 1 日的数据。



**示例 B：同年跨月场景（11 月 30 日至 12 月 1 日）**

* **处理逻辑**：
1. **年份延续**：在同一任务中，年份标签具备延续性，后续日期无需重复标注。
2. **时序衔接**：系统按日期顺序处理，自动将 11 月 30 日的末尾与 12 月 1 日的开头进行比对。
3. **结果**：12 月 1 日的数据将自动包含这段跨月睡眠的时长统计。



#### 3.2 业务约束要点

* **上下文一致性**：自动衔接逻辑仅在单次处理任务内有效。若不同月份的数据分批处理，需在当月起始位置手动补充前一日的末尾记录作为“逻辑引子”。
* **年份切换声明**：跨年点必须明确标注年份切换，否则系统将无法正确识别日期的绝对时间维度。


## 4. 健壮性校验与边界处理

为保证数据质量，系统在预处理阶段实施严格校验：

* **活动数量约束**：单日活动数量（`activityCount`）必须至少为 2 项，否则验证器会抛出 `Json_TooFewActivities` 警告，防止因数据过少导致睡眠生成逻辑错乱。
* **单调递增检查**：同一天内的时间戳必须严格单调递增，禁止“时光倒流”。
* **跨午夜计算**：在计算时长或生成时间戳时，若结束时间小于开始时间，算法会自动进位 24 小时以处理跨夜逻辑。
* **缺失处理**：若缺失起床关键字或上一日数据，系统将不生成 `sleep_night`，导致时间轴出现断层，以此作为数据不完整的信号。
